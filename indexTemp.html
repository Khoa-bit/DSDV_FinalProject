<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 7 - D3.js - GeoMapping</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  </head>

  <body>
    <h3 class="text-blue-500">Name: Nguyen Anh Khoa</h3>
    <h3 class="font-bold">Student ID: ITITIU19141</h3>
    <h3 class="font-bold">Course title: Data science and data visualization</h3>
    <h4 class="italic">Lab title: Lab 7 - D3.js - GeoMapping</h4>
    <p>
      This is all my own work. I did not copy the code from any other source
    </p>

    <main class="d-flex justify-content-center">
      <div class="svg-wrapper"></div>
    </main>

    <div class="d-flex justify-content-center">
      <div id="tooltip-group" class="visually-hidden">
        <h3>Province/City: <span id="province-value"></span></h3>
        <br />
        <h3>Cases: <span id="cases-value"></span></h3>
      </div>
    </div>

    <script>
      (async () => {
        let count = 0;

        // Function to convert data to desired format
        const rowConverter = function (d) {
          return {
            Country: d["Country/Region"],
            Latitude: parseFloat(d["Lat"]) ?? 0,
            Longitude: parseFloat(d["Long"]) ?? 0,
            casesNow: parseFloat(d["5/4/20"]) ?? 0,
          };
        };

        // Fetch the dataset from the provided URL
        const dataset = await d3.csv(
          "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
          rowConverter
        );

        const width = 720;
        const height = 420;
        const padding = 60;
        const r = 5;

        // Create xScale
        const xScale = d3
          .scaleLinear()
          .domain([
            d3.min(dataset, (d) => d.Latitude),
            d3.max(dataset, (d) => d.Latitude),
          ])
          .range([padding, width - padding * 2])
          .nice();

        // Create yScale
        const yScale = d3
          .scaleLinear()
          .domain([
            d3.min(dataset, (d) => d.Longitude),
            d3.max(dataset, (d) => d.Longitude),
          ])
          .range([height - padding, padding])
          .nice();

        // Remove existing SVG elements with id 'answer'
        d3.select("#answer").selectAll("svg").remove();

        // Create SVG element
        const svg = d3
          .select("#answer")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        // Create circles representing data points
        svg
          .selectAll("circle")
          .data(dataset)
          .enter()
          .append("circle")
          .attr("class", "dot")
          .attr("fill", (d) => "rgb(0, " + Math.round(d.casesNow) + ", 0)")
          .attr("cx", (d) => xScale(d.Latitude))
          .attr("cy", (d) => yScale(d.Longitude))
          .attr("r", r)
          .on("mouseover", function (e, d) {
            d3.select(this)
              .attr("r", r + 3)
              .attr("fill", "chocolate");

            svg
              .append("text")
              .attr("class", "dataInfo")
              .text(() => "Country: " + d.Country + ", Cases: " + d.casesNow)
              .attr("x", () => xScale(d.Latitude) - 15)
              .attr("y", () => yScale(d.Longitude) - 15);
          })
          .on("mouseout", function (d) {
            d3.select(this)
              .attr("r", r)
              .attr("fill", (d) => "rgb(0," + Math.round(d.casesNow) + ", 0)");

            svg.selectAll(".dataInfo").remove();
          });

        // Create x-axis
        const xAxis = d3.axisBottom().scale(xScale);

        svg
          .append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + (height - padding) + ")")
          .call(xAxis);

        // Create y-axis
        const yAxis = d3.axisLeft().scale(yScale);

        svg
          .append("g")
          .attr("class", "axis")
          .attr("transform", "translate(" + padding + ",0)")
          .call(yAxis);
      })();
    </script>
  </body>
</html>
